---
export interface Props {
  city?: string;
  days?: number;   // 1-7
}
const { city = 'å—äº¬å¸‚', days = 3 } = Astro.props;
if (days < 1 || days > 7) throw new Error('days å¿…é¡»åœ¨ 1-7 ä¹‹é—´');

const end = `https://60s.kemeow.top/v2/weather/forecast?query=${encodeURIComponent(city)}&days=${days}`;
const res = await fetch(end);
if (!res.ok) throw new Error(`æ¥å£å¼‚å¸¸ ${res.status}`);
const json: any = await res.json();
if (json.code !== 200) throw new Error(json.message || 'è·å–å¤±è´¥');
const { location, hourly_forecast, daily_forecast, sunrise_sunset } = json.data;

/* å¤©æ°”ä»£ç  -> Emoji */
const emoji: Record<string, string> = {
  '00':'â˜€ï¸','01':'â›…','02':'â˜ï¸','03':'ğŸŒ¦ï¸','04':'ğŸŒ©ï¸',
  '05':'ğŸŒ§ï¸','06':'ğŸŒ§ï¸','07':'ğŸŒ§ï¸','08':'â›ˆï¸','09':'ğŸŒ¨ï¸',
  '10':'â„ï¸','11':'â„ï¸','12':'ğŸŒ¬ï¸','13':'ğŸŒ«ï¸','14':'ğŸŒ«ï¸',
  '15':'ğŸŒ«ï¸','16':'ğŸŒ','17':'ğŸŒªï¸','18':'ğŸŒ«ï¸'
};
const getEmoji = (c: string) => emoji[c] || 'ğŸŒˆ';

/* æŒ‰æ—¥æœŸåˆ†ç»„å°æ—¶æ•°æ® */
const hourlyMap = new Map<string, typeof hourly_forecast>();
hourly_forecast.forEach((h: any) => {
  const d = h.datetime.slice(0,10);
  if (!hourlyMap.has(d)) hourlyMap.set(d, []);
  hourlyMap.get(d)!.push(h);
});
---
<style>
  :root{
    --border:#e5e7eb; --bg:#fff; --radius:12px; --text1:#111827; --text2:#6b7280;
    --primary:#3b82f6; --gap:.75rem; --cardPad:1.25rem;
  }
  .fw-card{border:1px solid var(--border);background:var(--bg);border-radius:var(--radius);padding:var(--cardPad);max-width:840px;margin:1.5rem auto;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;}
  .fw-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;}
  .fw-hd h3{margin:0;font-size:1.25rem;color:var(--text1)}
  .fw-hd small{font-size:.75rem;color:var(--text2)}
  .fw-section{margin-bottom:1.5rem}
  .fw-section-title{font-size:1rem;font-weight:600;margin:.5rem 0}
  details.fw-hourly{margin-bottom:.5rem}
  summary{cursor:pointer;font-weight:500;padding:.5rem;background:#f9fafb;border:1px solid var(--border);border-radius:6px}
  summary::-webkit-details-marker{color:var(--primary)}
  .hour-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:var(--gap);padding:.75rem 0}
  .hour-cell{text-align:center;font-size:.75rem;border:1px solid var(--border);border-radius:6px;padding:.5rem .25rem;background:#fafafa}
  .hour-cell .emoji{font-size:1.8rem;line-height:1}
  .hour-cell .temp{font-weight:600}
  .day-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:var(--gap)}
  .day-card{text-align:center;border:1px solid var(--border);border-radius:6px;padding:.75rem .5rem;background:#fafafa}
  .day-card .date{font-size:.8rem;color:var(--text2)}
  .day-card .emoji{font-size:2.2rem;line-height:1;margin:.25rem 0}
  .day-card .temp{font-size:.9rem;font-weight:600}
  .day-card .cond{font-size:.75rem;color:var(--text2)}
  .day-card .wind{font-size:.65rem;color:var(--text2);margin-top:.25rem}
  .day-card .sun{font-size:.65rem;color:var(--primary);margin-top:.25rem}
  .day-card .aqi{display:inline-block;margin-top:.25rem;font-size:.65rem;padding:2px 6px;border-radius:4px;color:#fff;background:var(--primary)}
</style>

<div class="fw-card">
  <!-- å¤´éƒ¨ -->
  <div class="fw-hd">
    <h3>{location.name} Â· å®Œæ•´å¤©æ°”æ•°æ®</h3>
    <small>æ•°æ®æ¥è‡ª 60s å¼€æºæ¥å£</small>
  </div>

  <!-- é€å°æ—¶ -->
  <section class="fw-section">
    <div class="fw-section-title">é€å°æ—¶é¢„æŠ¥ï¼ˆå…± {hourly_forecast.length} æ¡ï¼‰</div>
    {Array.from(hourlyMap.entries()).map(([date, list]) => (
      <details class="fw-hourly" open>
        <summary>{date}  &nbsp;Â·&nbsp;  {list.length} å°æ—¶</summary>
        <div class="hour-grid">
          {list.map((h:any) => (
            <div class="hour-cell">
              <div>{h.datetime.slice(-5)}</div>
              <div class="emoji">{getEmoji(h.condition_code)}</div>
              <div class="temp">{h.temperature}Â°</div>
              <div>{h.condition}</div>
              <div>{h.wind_direction}{h.wind_power}</div>
            </div>
          ))}
        </div>
      </details>
    ))}
  </section>

  <!-- é€æ—¥ -->
  <section class="fw-section">
    <div class="fw-section-title">é€æ—¥é¢„æŠ¥ + æ—¥å‡ºæ—¥è½</div>
    <div class="day-grid">
      {daily_forecast.map((d:any, i:number) => {
        const sun = sunrise_sunset[i] || {};
        return (
          <div class="day-card">
            <div class="date">{d.date} {new Date(d.date+' 00:00:00').toLocaleDateString('zh-CN',{weekday:'short'})}</div>
            <div class="emoji">{getEmoji(d.day_condition_code)}</div>
            <div class="temp">{d.min_temperature}Â° ~ {d.max_temperature}Â°</div>
            <div class="cond">ç™½ {d.day_condition} | å¤œ {d.night_condition}</div>
            <div class="wind">ç™½å¤© {d.day_wind_direction}{d.day_wind_power}</div>
            <div class="sun">ğŸŒ… {sun.sunrise_desc}  ğŸŒ‡ {sun.sunset_desc}</div>
            <span class="aqi" style={d.aqi_level===1?{background:'#10b981'}:{background:'#f59e0b'}}>
              {d.air_quality} {d.aqi}
            </span>
          </div>
        );
      })}
    </div>
  </section>
</div>